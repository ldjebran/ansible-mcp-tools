UV_ENV_FILE ?= .env
export UV_ENV_FILE
.PHONY: help install run dev clean test test-connection demo-pagination

# Default target
help:
	@echo "Ansible MCP Playbook Server - Available commands:"
	@echo "  install         Install dependencies with uv"
	@echo "  run             Run the MCP server"
	@echo "  dev             Run the server in development mode"
	@echo "  clean           Clean up cache files"
	@echo "  test            Test the server connection"
	@echo "  test-connection Test Ansible connection and list templates"
	@echo "  demo-pagination Demonstrate pagination with different page sizes"
	@echo "  deps            Check and install dependencies"
	@echo ""
	@echo "UV-specific commands:"
	@echo "  uv-sync    Sync dependencies with uv"
	@echo "  uv-sync-dev Sync dependencies with uv (including dev)"
	@echo "  uv-add     Show how to add new dependencies"
	@echo "  uv-add-dev Show how to add new dev dependencies"

# Install dependencies
install:
	@echo "ğŸ“¦ Installing dependencies with uv..."
	uv sync

# Install development dependencies
deps: install
	@echo "ğŸ”§ Installing development dependencies with uv..."
	uv sync --dev

# Run the server
run:
	@echo "ğŸš€ Starting Ansible MCP server..."
	uv run python server.py

# Run with the startup script
start:
	@echo "ğŸš€ Starting Ansible MCP server with startup script..."
	uv run python start_server.py

# Development mode (loads .env file)
dev: deps
	@echo "ğŸ”§ Starting server in development mode..."
	uv run python start_server.py

# Clean up cache files
clean:
	@echo "ğŸ§¹ Cleaning up cache files..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name ".pytest_cache" -delete
	@echo "âœ… Cleanup complete"

# Test connection to Ansible
test:
	@echo "ğŸ§ª Testing connection to Ansible..."
	uv run python test_connection.py

# Check environment configuration
check-env:
	@echo "ğŸ” Checking environment configuration..."
	@uv run python -c "import os; print('ANSIBLE_BASE_URL:', os.getenv('ANSIBLE_BASE_URL', 'NOT SET')); print('ANSIBLE_TOKEN:', 'SET' if os.getenv('ANSIBLE_TOKEN') else 'NOT SET')"

# Show server status
status:
	@echo "ğŸ“Š Server status:"
	@ps aux | grep "server.py" | grep -v grep || echo "Server not running"

# Add uv-specific commands
uv-sync:
	@echo "ğŸ”„ Syncing dependencies with uv..."
	uv sync

uv-sync-dev:
	@echo "ğŸ”„ Syncing dependencies with uv (including dev dependencies)..."
	uv sync --dev

uv-add:
	@echo "â• Add a new dependency with: uv add <package>"
	@echo "Example: uv add requests"

uv-add-dev:
	@echo "â• Add a new dev dependency with: uv add --dev <package>"
	@echo "Example: uv add --dev pytest"

# Create example environment file
setup-env:
	@echo "âš™ï¸ Creating example environment file..."
	@if [ ! -f .env ]; then \
		cp env.example .env; \
		echo "âœ… Created .env file from env.example"; \
		echo "ğŸ“ Please edit .env with your Ansible details"; \
	else \
		echo "âš ï¸ .env file already exists"; \
	fi

# Test Ansible connection
test-connection:
	@echo "ğŸ” Testing Ansible connection..."
	@if [ ! -f .env ]; then \
		echo "âš ï¸  No .env file found. Creating from env.example..."; \
		cp env.example .env; \
		echo "ğŸ“ Please edit .env with your Ansible details before running this command again."; \
		exit 1; \
	fi
	@echo "ğŸ“¡ Testing connection with environment variables from .env..."
	uv run python test_connection.py

# Demonstrate pagination functionality
demo-pagination:
	@echo "ğŸ“‘ Demonstrating pagination functionality..."
	@if [ ! -f .env ]; then \
		echo "âš ï¸  No .env file found. Creating from env.example..."; \
		cp env.example .env; \
		echo "ğŸ“ Please edit .env with your Ansible details before running this command again."; \
		exit 1; \
	fi
	@echo "ğŸ”„ Testing different page sizes to show pagination in action..."
	uv run python demo_pagination.py 
